---
title: 'Statistical Analysis: Paired vs Unpaired & Categorical Variables'
author: "Gene Expression Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
  pdf_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Setup

Load the existing project infrastructure and prepare data.

```{r load-environment}
# Source existing R files
source("R/load_packages.R")
source("R/load_data.R")
source("R/munging.R")
source("R/diff_models.R")

# Setup libraries
setup_environment()

# Load and process data
eset <- get_geo_data(gse_id = "GSE47881")
final_df <- process_gene_data(eset)

# Target genes
target_genes <- c(
  "211980_at", "204114_at", "212013_at", "204008_at",
  "218429_s_at", "203477_at", "205656_at", "204115_at"
)
```

------------------------------------------------------------------------

# 1. Paired vs Unpaired Comparison

**Goal**: Demonstrate the importance of accounting for data structure.

## 1.1 Conceptual Overview

| Approach | Model | What it tests |
|----|----|----|
| **Paired** | `GeneDiff ~ 1` | Is the mean *within-subject* change ≠ 0? |
| **Unpaired** | `Gene ~ Pre_Post` | Is the mean of Post different from mean of Pre, ignoring subject pairing? |

The paired approach removes between-subject variability because each subject serves as their own control. The unpaired approach treats Pre and Post as independent groups, which inflates the error term.

## 1.2 Prepare Data for Both Analyses

We need to reconstruct the long-format data for the unpaired analysis.

```{r prepare-long-format}
# Get the original expression data and phenotype info
expr_matrix <- exprs(eset)
pdata <- pData(eset)

# Create clean long-format data
long_df <- pdata %>%
  select(geo_accession,
         subject_id = `patientid:ch1`,
         timepoint = `time:ch1`,
         age = `age:ch1`) %>%
  mutate(
    age = as.numeric(age),
    subject_id = as.character(subject_id),
    # Create binary Pre/Post indicator
    is_post = ifelse(timepoint == "post-training", 1, 0),
    timepoint_factor = factor(timepoint, levels = c("pre-training", "post-training"))
  )

# Add expression values for target genes
for (gene in target_genes) {
  if (gene %in% rownames(expr_matrix)) {
    long_df[[gene]] <- as.numeric(expr_matrix[gene, long_df$geo_accession])
  }
}

head(long_df)
```

## 1.3 Run Both Analyses

### Paired Analysis (Current Approach)

This uses the already-computed difference scores and tests if the mean difference ≠ 0.

```{r paired-analysis}
paired_results <- run_intercept_models(final_df, target_genes)
paired_results$Analysis <- "Paired"
knitr::kable(paired_results, digits = 4, caption = "Paired Analysis Results")
```

### Unpaired Analysis (Naive Approach)

This ignores the paired structure and compares Pre vs Post as independent groups.

```{r unpaired-analysis}
run_unpaired_models <- function(df, genes) {
  results_list <- lapply(genes, function(g) {
    if (!g %in% colnames(df)) {
      return(NULL)
    }

    # Formula: Gene ~ timepoint (unpaired t-test equivalent)
    f <- as.formula(paste0("`", g, "` ~ timepoint_factor"))

    model <- lm(f, data = df)
    s <- summary(model)

    # Extract the Post coefficient (difference from Pre)
    data.frame(
      Gene = g,
      Model = "Unpaired",
      Estimate_Mean_Diff = coef(s)[2, 1],  # Post - Pre difference
      SE = coef(s)[2, 2],
      T_Value = coef(s)[2, 3],
      P_Value = coef(s)[2, 4]
    )
  })

  do.call(rbind, results_list)
}

unpaired_results <- run_unpaired_models(long_df, target_genes)
unpaired_results$Analysis <- "Unpaired"
knitr::kable(unpaired_results, digits = 4, caption = "Unpaired Analysis Results")
```

## 1.4 Direct Comparison

```{r comparison-table}
# Merge results for comparison
comparison <- merge(
  paired_results[, c("Gene", "Estimate_Mean_Diff", "SE", "P_Value")],
  unpaired_results[, c("Gene", "Estimate_Mean_Diff", "SE", "P_Value")],
  by = "Gene",
  suffixes = c("_Paired", "_Unpaired")
)

# Calculate ratios
comparison$SE_Ratio <- comparison$SE_Unpaired / comparison$SE_Paired
comparison$Significance_Paired <- ifelse(comparison$P_Value_Paired < 0.05, "*", "")
comparison$Significance_Unpaired <- ifelse(comparison$P_Value_Unpaired < 0.05, "*", "")

knitr::kable(comparison, digits = 4, caption = "Paired vs Unpaired: Side-by-Side Comparison")
```

### Visualization: P-value Comparison

```{r pvalue-comparison-plot, fig.width=8, fig.height=5}
comparison_long <- data.frame(
  Gene = rep(comparison$Gene, 2),
  Analysis = rep(c("Paired", "Unpaired"), each = nrow(comparison)),
  P_Value = c(comparison$P_Value_Paired, comparison$P_Value_Unpaired)
)

ggplot(comparison_long, aes(x = Gene, y = -log10(P_Value), fill = Analysis)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "red") +
  labs(
    title = "Paired vs Unpaired Analysis: Statistical Significance",
    subtitle = "Red dashed line = p = 0.05 threshold",
    x = "Gene",
    y = "-log10(P-value)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("Paired" = "#2E86AB", "Unpaired" = "#A23B72"))
```

### Visualization: Standard Error Comparison

```{r se-comparison-plot, fig.width=8, fig.height=5}
se_long <- data.frame(
  Gene = rep(comparison$Gene, 2),
  Analysis = rep(c("Paired", "Unpaired"), each = nrow(comparison)),
  SE = c(comparison$SE_Paired, comparison$SE_Unpaired)
)

ggplot(se_long, aes(x = Gene, y = SE, fill = Analysis)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Standard Error Comparison: Paired vs Unpaired",
    subtitle = "Lower SE = more precise estimate",
    x = "Gene",
    y = "Standard Error"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("Paired" = "#2E86AB", "Unpaired" = "#A23B72"))
```

------------------------------------------------------------------------

# 2. Categorical Variable Analysis

**Goal**: Incorporate a categorical variable to explore group differences.

## 2.1 Check Existing Categorical Variables

```{r check-pdata}
# Inspect available phenotype data
cat("Available phenotype columns:\n")
print(colnames(pdata))

# Check for potential categorical variables - only select columns that exist
potential_cols <- c("patientid:ch1", "time:ch1", "age:ch1", "gender:ch1", "sex:ch1")
existing_cols <- potential_cols[potential_cols %in% colnames(pdata)]
cat("\nSample of phenotype data:\n")
print(head(pdata[, existing_cols]))
```

```{r gender-check}
# Check if gender/sex exists (may be named differently)
gender_col <- NULL
if ("gender:ch1" %in% colnames(pdata)) {
  gender_col <- "gender:ch1"
} else if ("sex:ch1" %in% colnames(pdata)) {
  gender_col <- "sex:ch1"
}

if (!is.null(gender_col)) {
  cat("Gender/Sex distribution:\n")
  print(table(pdata[[gender_col]]))
  has_gender <- TRUE
} else {
  cat("Gender/Sex column not found. Will create categorical variable from Age.\n")
  has_gender <- FALSE
}
```

## 2.2 Create Categorical Variables

We'll create two categorical variables:

1.  **Age Group**: High/Low based on median split
2.  **Responder Status**: Based on gene expression change (for a selected gene)

```{r create-categorical}
# Get unique subject-level data
subject_df <- final_df[, c("subject_id", "age")]

# Age Group: Median Split
median_age <- median(subject_df$age, na.rm = TRUE)
subject_df$age_group <- ifelse(subject_df$age >= median_age, "High_Age", "Low_Age")
subject_df$age_group <- factor(subject_df$age_group, levels = c("Low_Age", "High_Age"))

cat("Age Group Distribution (Median =", median_age, "):\n")
print(table(subject_df$age_group))

# Responder Status: Based on first target gene's change
# Using 211980_at as the reference gene
ref_gene <- "211980_at"
diff_col <- paste0(ref_gene, "_diff")

if (diff_col %in% colnames(final_df)) {
  median_change <- median(final_df[[diff_col]], na.rm = TRUE)
  final_df$responder <- ifelse(final_df[[diff_col]] >= median_change, "High_Responder", "Low_Responder")
  final_df$responder <- factor(final_df$responder, levels = c("Low_Responder", "High_Responder"))

  cat("\nResponder Status Distribution (based on", ref_gene, "):\n")
  print(table(final_df$responder))
}

# Add age_group to final_df
final_df$age_group <- subject_df$age_group
```

## 2.3 Categorical Analysis: Age Group Effect

Test whether the gene expression change differs between age groups.

```{r age-group-analysis}
run_categorical_models <- function(df, genes, group_var) {
  results_list <- lapply(genes, function(g) {
    col_name <- paste0(g, "_diff")

    if (!col_name %in% colnames(df)) {
      col_name <- paste0("X", g, "_diff")
    }
    if (!col_name %in% colnames(df)) return(NULL)

    # Formula: GeneDiff ~ Group
    f <- as.formula(paste0("`", col_name, "` ~ ", group_var))

    model <- lm(f, data = df)
    s <- summary(model)

    # t-test for comparison
    group_vals <- df[[group_var]]
    gene_vals <- df[[col_name]]
    tt <- t.test(gene_vals ~ group_vals)

    data.frame(
      Gene = g,
      Group_Variable = group_var,
      Group_Diff = coef(s)[2, 1],
      SE = coef(s)[2, 2],
      T_Value = coef(s)[2, 3],
      P_Value = coef(s)[2, 4],
      T_Test_P = tt$p.value
    )
  })

  do.call(rbind, results_list)
}

# Age Group Analysis
age_group_results <- run_categorical_models(final_df, target_genes, "age_group")
knitr::kable(age_group_results, digits = 4, caption = "Gene Change by Age Group")
```

## 2.4 Visualization: Boxplots by Age Group

```{r boxplot-age-group, fig.width=10, fig.height=6}
# Prepare data for plotting
plot_data <- final_df %>%
  select(subject_id, age_group, ends_with("_diff")) %>%
  pivot_longer(
    cols = ends_with("_diff"),
    names_to = "Gene",
    values_to = "Diff"
  ) %>%
  mutate(Gene = gsub("_diff$", "", Gene)) %>%
  filter(Gene %in% target_genes)

ggplot(plot_data, aes(x = Gene, y = Diff, fill = age_group)) +
  geom_boxplot(alpha = 0.7) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  labs(
    title = "Gene Expression Change by Age Group",
    subtitle = "Positive values indicate increased expression post-training",
    x = "Gene",
    y = "Expression Change (Post - Pre)",
    fill = "Age Group"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("Low_Age" = "#F18F01", "High_Age" = "#C73E1D"))
```

## 2.5 Responder Analysis

```{r responder-analysis}
# Responder Status Analysis
responder_results <- run_categorical_models(final_df, target_genes, "responder")
knitr::kable(responder_results, digits = 4, caption = "Gene Change by Responder Status")
```

```{r boxplot-responder, fig.width=10, fig.height=6}
# Add responder to plot_data
plot_data_resp <- final_df %>%
  select(subject_id, responder, ends_with("_diff")) %>%
  pivot_longer(
    cols = ends_with("_diff"),
    names_to = "Gene",
    values_to = "Diff"
  ) %>%
  mutate(Gene = gsub("_diff$", "", Gene)) %>%
  filter(Gene %in% target_genes)

ggplot(plot_data_resp, aes(x = Gene, y = Diff, fill = responder)) +
  geom_boxplot(alpha = 0.7) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  labs(
    title = "Gene Expression Change by Responder Status",
    subtitle = paste("Responder defined by", ref_gene, "expression change"),
    x = "Gene",
    y = "Expression Change (Post - Pre)",
    fill = "Responder Status"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("Low_Responder" = "#3D5A80", "High_Responder" = "#98C1D9"))
```

------------------------------------------------------------------------

# 3. Interpretation

## 3.1 Paired vs Unpaired: Key Findings

```{r interpretation-paired}
# Summary statistics
avg_se_ratio <- mean(comparison$SE_Ratio, na.rm = TRUE)
n_sig_paired <- sum(comparison$P_Value_Paired < 0.05)
n_sig_unpaired <- sum(comparison$P_Value_Unpaired < 0.05)
```

**Key Observations:**

1.  **Standard Error Comparison**: The unpaired analysis shows SE values that are on average **`r round(avg_se_ratio, 2)`x** the paired analysis SE. The SE ratio reflects how much precision is gained by accounting for the paired structure; it follows approximately $\text{SE ratio} \approx 1 / \sqrt{1 - r}$, where $r$ is the Pre-Post correlation within subjects. Our modest ratio implies relatively low Pre-Post correlation in this dataset, suggesting the between-subject variability is not dramatically larger than the within-subject variability. This is a point worth exploring further.

2.  **Statistical Power**:

    -   Paired analysis: **`r n_sig_paired`** genes significant at p < 0.05
    -   Unpaired analysis: **`r n_sig_unpaired`** genes significant at p < 0.05
    -   Both approaches detected the same number of significant genes, indicating the training effect is strong enough to overcome the variance inflation.

3.  **Interpretation**: In this dataset, the training effect is sufficiently strong that both approaches yield similar conclusions. The paired design remains theoretically preferable because it explicitly models the within-subject correlation.

## 3.2 Categorical Analysis: Key Findings

```{r interpretation-categorical}
n_sig_age <- sum(age_group_results$P_Value < 0.05, na.rm = TRUE)
n_sig_resp <- sum(responder_results$P_Value < 0.05, na.rm = TRUE)
```

**Age Group Analysis:**

-   **`r n_sig_age`** genes showed significantly different responses between High and Low age groups (p < 0.05)
-   Age does not appear to moderate the training effect for these genes - both age groups respond similarly to training.

**Responder Analysis:**

-   **`r n_sig_resp`** genes showed significantly different patterns between High and Low responders
-   This indicates correlated gene responses: individuals who respond strongly on the reference gene (211980_at) also tend to show stronger responses on other genes.
-   Note: This analysis is partly circular since responder status was defined by one of the target genes

## 3.3 Summary Table

```{r summary-table}
summary_df <- data.frame(
  Analysis = c("Paired vs Unpaired", "Age Group Effect", "Responder Effect"),
  Key_Finding = c(
    paste0("SE inflation: ", round(avg_se_ratio, 2), "x; Power difference: ", n_sig_paired - n_sig_unpaired, " genes"),
    paste0(n_sig_age, " genes differ by age group"),
    paste0(n_sig_resp, " genes differ by responder status")
  ),
  Implication = c(
    "Strong effects detectable either way; paired still theoretically preferable",
    "Age does not moderate training response",
    "Correlated individual response patterns across genes"
  )
)

knitr::kable(summary_df, caption = "Analysis Summary")
```

------------------------------------------------------------------------

